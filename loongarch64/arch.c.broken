/** * @file    arch.c * @brief   LoongArch64架构上下文管理实现 * @author  Intewell Team * @date    2025-01-21 * @version 1.0 * * @details 本文件实现了LoongArch64架构上下文管理相关功能 *          - 上下文切换 *          - 异常上下文管理 *          - 函数参数获取 *          - 线程上下文初始化 * * @copyright Copyright (c) 2025 Intewell Team *//*************************** 头文件包含 ****************************/#include <ttos_arch.h>#include <cpu.h>#include <ttos.h>#include <ttosProcess.h>/*************************** 宏定义 *****************************/#define REG_A0          4U   /* 参数寄存器0 / 返回值寄存器0 */#define REG_A1          5U   /* 参数寄存器1 / 返回值寄存器1 */#define REG_SP          3U   /* 堆栈指针寄存器 */#define MAX_ARG_REGS    8U   /* a0-a7，共8个参数寄存器 *//*************************** 函数实现 ****************************//** * @brief 设置任务上下文的堆栈指针 * @param ctx 任务上下文指针 * @param sp  要设置的堆栈指针值 * @return 成功返回0 */int32_t arch_switch_context_set_stack(T_TBSP_TaskContext *ctx, uint64_t sp){    ctx->sp = (int64_t)sp;    return 0;}/** * @brief 设置异常上下文的返回值 * @param context 异常上下文指针 * @param value   要设置的返回值 * @return 成功返回0 */int32_t arch_context_set_return(arch_exception_context_t *context, uint64_t value){    /* a0是函数返回值寄存器（r4） */    context->regs[REG_A0] = (int64_t)value;    return 0;}/** * @brief 设置异常上下文的堆栈指针 * @param context 异常上下文指针 * @param value   要设置的堆栈指针值 * @return 成功返回0 */int32_t arch_context_set_stack(arch_exception_context_t *context, uint64_t value){    /* sp（r3）寄存器用于堆栈指针 */    context->regs[REG_SP] = (int64_t)value;    return 0;}/** * @brief 初始化线程上下文 * @param context 异常上下文指针 * @return 成功返回0 */int32_t arch_context_thread_init(arch_exception_context_t *context){    /* 当前实现：返回成功     * 未来扩展：     * 1. 清零所有寄存器     * 2. 设置初始堆栈指针     * 3. 配置初始状态     * 4. 设置特权级（PLV0/PLV3）     */    return 0;}/** * @brief 获取函数参数 * @param context 异常上下文指针 * @param index   参数索引（0-7，对应a0-a7） * @param value   输出参数，用于存储获取的参数值 * @return 成功返回0 */int32_t arch_context_get_args(const arch_exception_context_t *context,                               uint32_t index,                               uint64_t *value){    /* index=0 -> a0寄存器（r4）     * index=1 -> a1寄存器（r5）     * ...     * index=7 -> a7寄存器（r11）     */    *value = (uint64_t)context->regs[REG_A0 + index];    return 0;}/** * @brief 设置函数参数 * @param context 异常上下文指针 * @param index   参数索引（0-7，对应a0-a7） * @param value   要设置的参数值 * @return 成功返回0 */int32_t arch_context_set_args(arch_exception_context_t *context,                               uint32_t index,                               uint64_t value){    context->regs[REG_A0 + index] = (int64_t)value;    return 0;}